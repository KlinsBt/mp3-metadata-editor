<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MP3 Metadata Editor</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>MP3 Metadata Editor</h1>
      </div>

      <div class="content">
        <div class="upload-section">
          <div class="file-input-wrapper">
            <input
              type="file"
              id="mp3File"
              class="file-input"
              accept=".mp3,audio/mpeg"
            />
            <label for="mp3File" class="file-input-button">
              <svg
                class="icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
              Select MP3 File
            </label>
          </div>
          <p style="margin-top: 12px; color: #6b7280; font-size: 14px">
            Choose an MP3 file to edit its metadata and artwork
          </p>
        </div>

        <div id="editor" class="editor-section">
          <div class="metadata-grid">
            <div>
              <h2 class="section-title">Track Information</h2>
              <div class="metadata-form">
                <div class="form-group">
                  <label for="title">Title</label>
                  <input type="text" id="title" />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="artist">Artist/s</label>
                    <input type="text" id="artist" />
                  </div>
                  <div class="form-group">
                    <label for="album">Album Name</label>
                    <input type="text" id="album" />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="year">Year</label>
                    <input type="number" id="year" />
                  </div>
                  <div class="form-group">
                    <label for="track">Track Number</label>
                    <input type="number" id="track" />
                  </div>
                </div>

                <div class="form-group">
                  <label for="genre">Genre</label>
                  <input type="text" id="genre" />
                </div>
              </div>
            </div>

            <div>
              <h2 class="section-title">Song Artwork</h2>
              <div class="artwork-section">
                <div class="artwork-container" id="artworkContainer">
                  <div class="artwork-placeholder" id="artworkPlaceholder">
                    <div class="artwork-placeholder-icon">ðŸŽµ</div>
                    <div>No Artwork</div>
                  </div>
                  <img
                    id="currentArtwork"
                    class="current-artwork"
                    style="display: none"
                  />
                </div>

                <div class="artwork-controls">
                  <input
                    type="file"
                    id="artworkFile"
                    accept="image/*"
                    style="display: none"
                  />
                  <button
                    class="btn btn-primary"
                    onclick="document.getElementById('artworkFile').click()"
                  >
                    <svg
                      class="icon"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                      />
                    </svg>
                    Upload
                  </button>
                  <button class="btn btn-secondary" onclick="removeArtwork()">
                    <svg
                      class="icon"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                      />
                    </svg>
                    Remove
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="save-section">
            <button class="btn btn-success" onclick="saveMetadata()">
              <svg
                class="icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              Save & Download
            </button>
          </div>

          <div id="status"></div>
        </div>
      </div>
    </div>

    <script src="./jsmediatags.min.js"></script>
    <script src="./browser-id3-writer.min.js"></script>
    <script>
      let currentFile = null;
      let currentArtwork = null;

      document
        .getElementById("mp3File")
        .addEventListener("change", handleFileSelect);
      document
        .getElementById("artworkFile")
        .addEventListener("change", handleArtworkSelect);

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (
          !file.type.includes("audio/mpeg") &&
          !file.name.toLowerCase().endsWith(".mp3")
        ) {
          showStatus("Please select a valid MP3 file.", "error");
          return;
        }

        currentFile = file;
        // showStatus("Loading MP3 metadata...", "success");

        // Read existing metadata
        jsmediatags.read(file, {
          onSuccess: function (tag) {
            loadMetadata(tag);
            document.getElementById("editor").style.display = "block";
            // showStatus(
            //   "MP3 loaded successfully. Edit the metadata below.",
            //   "success"
            // );
          },
          onError: function (error) {
            console.log("Error reading metadata:", error);
            // Still show editor even if metadata reading fails
            document.getElementById("editor").style.display = "block";
            showStatus(
              "MP3 loaded. Metadata reading failed, but you can still edit.",
              "success"
            );
          },
        });
      }

      function loadMetadata(tag) {
        const tags = tag.tags;

        document.getElementById("title").value = tags.title || "";
        document.getElementById("artist").value = tags.artist || "";
        document.getElementById("album").value = tags.album || "";
        document.getElementById("year").value = tags.year || "";
        document.getElementById("genre").value = tags.genre || "";
        document.getElementById("track").value = tags.track || "";

        // Load artwork if present
        if (tags.picture) {
          const picture = tags.picture;
          const base64String = arrayToBase64(picture.data);
          const src = `data:${picture.format};base64,${base64String}`;
          showArtwork(src);
          currentArtwork = {
            data: picture.data,
            format: picture.format,
          };
        }
      }

      function arrayToBase64(array) {
        let binary = "";
        for (let i = 0; i < array.length; i++) {
          binary += String.fromCharCode(array[i]);
        }
        return btoa(binary);
      }

      function showArtwork(src) {
        const container = document.getElementById("artworkContainer");
        const placeholder = document.getElementById("artworkPlaceholder");
        const artwork = document.getElementById("currentArtwork");

        placeholder.style.display = "none";
        artwork.src = src;
        artwork.style.display = "block";
        container.classList.add("has-image");
      }

      function removeArtwork() {
        const container = document.getElementById("artworkContainer");
        const placeholder = document.getElementById("artworkPlaceholder");
        const artwork = document.getElementById("currentArtwork");

        placeholder.style.display = "flex";
        artwork.style.display = "none";
        container.classList.remove("has-image");
        currentArtwork = null;
      }

      function showStatus(message, type) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
        status.style.display = "block";

        if (type === "success") {
          setTimeout(() => {
            status.style.display = "none";
          }, 5000);
        }
      }

      async function saveMetadata() {
        if (!currentFile) {
          showStatus("No MP3 file selected.", "error");
          return;
        }

        const saveBtn = event.target;
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML =
          '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Processing...';
        saveBtn.disabled = true;

        showStatus("Processing and saving metadata...", "success");

        try {
          const arrayBuffer = await currentFile.arrayBuffer();
          const writer = new ID3Writer(new Uint8Array(arrayBuffer));

          writer
            .setFrame("TIT2", document.getElementById("title").value)
            .setFrame("TPE1", [document.getElementById("artist").value])
            .setFrame("TALB", document.getElementById("album").value)
            .setFrame("TYER", document.getElementById("year").value)
            .setFrame("TCON", [document.getElementById("genre").value])
            .setFrame("TRCK", document.getElementById("track").value);

          if (currentArtwork) {
            writer.setFrame("APIC", {
              type: 3,
              data: new Uint8Array(currentArtwork.data),
              description: "Cover",
              mimeType: currentArtwork.format,
            });
          }

          writer.addTag();

          // Create the new MP3 blob
          const blob = writer.getBlob();
          const url = URL.createObjectURL(blob);

          // Download updated MP3
          const a = document.createElement("a");
          a.href = url;
          a.download = currentFile.name.replace(".mp3", "_edited.mp3");
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showStatus(
            "Metadata updated and MP3 downloaded successfully!",
            "success"
          );
        } catch (error) {
          showStatus("Error processing file. Please try again.", "error");
          console.error(error);
        } finally {
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
        }
      }

      function handleArtworkSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          showStatus("Please select a valid image file.", "error");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          // Keep raw bytes for ID3 APIC frame
          const arrayBuffer = e.target.result;
          const uint8Array = new Uint8Array(arrayBuffer);
          currentArtwork = {
            data: Array.from(uint8Array),
            format: file.type,
          };

          // Show preview
          const imgReader = new FileReader();
          imgReader.onload = function (evt) {
            showArtwork(evt.target.result);
          };
          imgReader.readAsDataURL(file);
        };
        reader.readAsArrayBuffer(file);
      }
    </script>
  </body>
</html>
